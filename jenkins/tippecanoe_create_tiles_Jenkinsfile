pipeline {
  agent {
        node {
            label 'node:slave'
        }
    }
  stages {
    stage('Checkout repo and pull from S3') {
      agent any 
      steps {
        sh 'wget -O DOIRootCA2.cer http://sslhelp.doi.net/docs/DOIRootCA2.cer'
        git "https://github.com/usgs-makerspace/wbeep-processing"
        sh 'aws s3 sync s3://prod-owi-resources/resources/Application/wbeep/${TIER}/hru_shape . --exclude "*" --include "hrus.geojson"'
		sh 'aws s3 sync s3://prod-owi-resources/resources/Application/wbeep/${TIER}/hru_data . --exclude "*" --include "hru_data.csv"'
      }
    }
    stage('create tileset') {
      agent {
        docker {
          image 'code.chs.usgs.gov:5001/wma/iidd/wbeep-data-processing:tippecanoe-latest'
          alwaysPull true
        } 
      }
      steps {
        sh 'tippecanoe -Z4 -z8 --no-tiny-polygon-reduction --detect-shared-borders --simplify-only-low-zooms --simplification=5 --force --output-to-directory tile_dir_simple5 hrus.geojson'
		sh 'tile-join --output-to-directory tile_dir_simple5_data -c hru_data.csv tile_dir_simple5' 
      }
    }
    stage('push to S3') {
      agent any
      steps { 
        sh 'aws s3 sync tile_dir_simple5_data s3://prod-owi-resources/resources/Application/wbeep/${TIER}/hru_shape/tile_dir_simple5_data'
      }
    }
  }
}